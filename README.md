# Чат

## О проекте

Это клиент‑серверный чат на **Java**, реализованный через чистые TCP‑сокеты. Сервер мультипоточный: для каждого подключившегося клиента создаётся отдельный поток. Для хранения истории используется **PostgreSQL**. Для быстрого запуска проекта подготовлен `docker-compose` — поднять сервер и базу можно одной командой.

> В проекте классы клиента и сервера находятся в разных пакетах: `kz.shift.chat.server` и `kz.shift.chat.client`. Общие классы находятся в пакете `kz.shift.chat.common`.

## Что было сделано

* **Клиент и сервер реализованы** и могут запускаться независимо (каждый имеет свой `main`).
* **Чистые сокеты:** сетевое взаимодействие реализовано с использованием `ServerSocket` / `Socket` (TCP).
* **Многопоточность на сервере:** для каждого подключения запускается отдельный поток обработки клиента, что обеспечивает одновременную работу множества подключений.
* **Проверка уникальности имени:** сервер не разрешает подключение клиента с именем, уже занятым другим подключенным пользователем.
* **Оповещения о подключении/отключении:** при подключении/отключении формируются `SystemDTO` сообщения и рассылаются всем клиентам.
* **Рассылка сообщений:** при поступлении `MessageDTO` сервер пересылает сообщение всем остальным подключённым клиентам.
* **Сохранение истории сообщений в PostgreSQL:** сервер сохраняет входящие сообщения в таблицу `messages` и по подключению может отдавать историю.
* **Работа с базой данных:** реализовано через JDBC.
* **Сериализация JSON/Jackson:** DTO-сообщения сериализуются/десериализуются через Jackson.
* **Docker / docker-compose:** подготовлен `docker-compose.yml` (поднимает Postgres и сервер) — запуск `docker-compose up` поднимает окружение.

## Что реализовано в клиенте (кратко)

* Клиент запрашивает у пользователя **ник (имя)** и **адрес/порт сервера** при старте подключения.
* Каждое сообщение помечается временем отправки (поля `createdAt` в `MessageDTO`).
* Клиент может запускаться в виде jar: `java -jar build/libs/client-1.0.jar`.
* Клиент использует тот же набор DTO для коммуникации: `JoinRequestDTO`, `JoinResponseDTO`, `MessageDTO`, `UsersUpdateDTO`, `SystemDTO`, `ErrorDTO`.

## DTO и протокол обмена

JSON‑протокол на основе DTO. Базовый класс — `DTO` с полем `type` (тип сообщения). Используются следующие DTO (файлы в `kz.shift.chat.common.dto`):

* `DtoType` — перечисление типов: `JOIN`, `SYSTEM`, `MESSAGE`, `USERS_UPDATE`, `ERROR`, `UNKNOWN`.
* `JoinRequestDTO` — запрос на подключение (с полем `username`).
* `JoinResponseDTO` — ответ при подключении (список пользователей `users` и история `history`).
* `MessageDTO` — текстовое сообщение (`id`, `sender`, `text`, `createdAt`).
* `SystemDTO` — системные сообщения (например, "user joined").
* `UsersUpdateDTO` — обновлённый список пользователей.
* `ErrorDTO` — сообщения об ошибках.

## Схема БД

Используется таблица `messages`:

```sql
CREATE TABLE IF NOT EXISTS messages (
    id SERIAL PRIMARY KEY,
    sender VARCHAR(255) NOT NULL,
    text TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

Сохранение/чтение сообщений выполняется через JDBC (в проекте используется HikariCP для пула соединений и драйвер Postgres).

## Сборка и запуск

### Сборка (Gradle)

```bash
# В корне проекта
./gradlew serverJar
./gradlew clientJar
```

После сборки `server-1.0.jar` и `client-1.0.jar` появятся в `build/libs/`.

### Запуск сервера рекомендуется через Docker

```bash
# Пример запуска
docker-compose up
```

### Запуск клиента локально

```bash
java -jar build/libs/client-1.0.jar
```

При запуске клиента он запрашивает адрес/порт сервера и имя пользователя (ник), после чего пытается подключиться.